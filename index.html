<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dice</title>
<link rel="icon" type="image/svg" href="icon.svg">
<link rel="apple-touch-icon" href="icon.png" sizes="180x80">
<link rel="manifest" href="manifest.json">
<style>
body {
	background-color: #eee;
}
#container {
    width: 100%; height: 100%;
    display: flex; display: -webkit-flex;
    flex-direction: column; -webkit-flex-direction: column;
    justify-content: space-between; -webkit-justify-content: space-between;
    align-items: center; -webkit-align-items: center;
	text-align: center;
	vertical-align: middle;
}
#header {
	width: 90%; height: 5%;
    display: flex; display: -webkit-flex;
    flex-direction: row; -webkit-flex-direction: row;
    justify-content: space-between; -webkit-justify-content: space-between;
    align-items: center; -webkit-align-items: center;
}
.cubeScreen {
    width: 90%; height: 90%;
    display: flex; display: -webkit-flex;
    flex-direction: column; -webkit-flex-direction: column;
    justify-content: center; -webkit-justify-content: center;
    align-items: center; -webkit-align-items: center;
	background-color: #fff;
}
#footer {
	width: 90%; height: 5%; margin: 0px;
    display: flex; display: -webkit-flex;
    flex-direction: row; -webkit-flex-direction: row;
    justify-content: flex-end; -webkit-justify-content: flex-end;
    align-items: center; -webkit-align-items: center;
}
#logo {
	width: 80%; height: 40px;
    display: flex; display: -webkit-flex;
    flex-direction: row; -webkit-flex-direction: row;
    justify-content: flex-start; -webkit-justify-content: flex-start;
    align-items: center; -webkit-align-items: center;
    padding: 0px 10px;
    font-family: Courier, monospace, sans-serif;
}
#logo a {
    color: #000;
    text-decoration: none;
}
#icon {
	width: 80px; height: 80px;
	background-image: url('icon.svg');
	background-position: 0px 0px;
    margin: 0px 10px;
}
#menu {
	width: 80px;
    display: flex; display: -webkit-flex;
    flex-direction: row; -webkit-flex-direction: row;
    justify-content: space-between; -webkit-justify-content: space-between;
    align-items: flex-end; -webkit-align-items: flex-end;
}
#minus {
	width: 40px; height: 40px;
	background-image: url('dice.svg');
	background-position: 0px -160px;
}
#plus {
	width: 40px; height: 40px;
	background-image: url('dice.svg');
	background-position: -40px -160px;
}
#menu a {
	transform: scale(1);
}
#menu a:hover {
	transform: scale(1.1);
}
#menu a:active {
	transform: scale(0.8);
}
</style>
</head>
<body>
<div id="container">
	<h1 id="header">
		<div id="logo">
			<!--a id="icon" href="?"></a-->
			<a href="?">Dice</a>
		</div>
		<div id="menu">
			<a id="minus" href="javascript:onMinus()"></a>
			<a id="plus" href="javascript:onPlus()"></a>
		</div>
	</h1>
	<div class="cubeScreen"></div>
	<h6 id="footer">
	</h6>
</div>
<script src="cube-api-0.8.js"></script>
<!--Menu--><script>
	var params = cubeParamNumbers("d");
	var counts = params[0] ? params[0] : 1; // Counts of dice.
	var maximum = params[1] ? params[1] : 6; // Maximum of dice faces.
	var rolling = 0; // Rolling count.

	// Minus dice counts.
	var onMinus = () => {
		counts = counts > 1 ? counts - 1 : counts;
		rolling = -1; // Reroll.
	};

	// Plus dice counts.
	var onPlus = () => {
		counts = counts < 20 ? counts + 1 : counts;
		rolling = -1; // Reroll.
	};
</script><!--/Menu-->
<!--Main--><script>
(async()=>{
	//var params = cubeParamNumbers("d");
	//var counts = params[0] ? params[0] : 1; // Counts of dice.
	//var maximum = params[1] ? params[1] : 6; // Maximum of dice faces.
	//var rolling = 0; // Rolling count.

	// Resize screen.
	cubeResizeScreen(300, 300);

	// Create sprites.
	var sprite = await cubeSprite("dice.svg", 40, 40);
	var sprites = [];
	for (var i = 0; i < 20; i++) {
		sprites[i] = sprite.clone();
	}

	// Main loop.
	while (true) {

		// Sprite lines and rows.
		var lineMax = cubeSqrt(counts - 1) + 1;
		var lines = cubeDiv(counts - 1, lineMax) + 1;
		var rows = [];
		for (var i = 0; i < lines; i++) {
			rows[i] = i > 0 ? lineMax : (cubeMod(counts - 1, lineMax) + 1);
		}

		// Sprite scale.
		var scale = 5 / (counts < lineMax ? counts : lines >= lineMax ? lines : lineMax);

		// Rolling dice.
		var result = 0;
		var angle = 0;
		var randoms = [];
		for (rolling = 1; rolling >= 1; rolling++) {

			// Screen size.
			var size = cubeScreenSize();

			// Wait for input.
			await cubeReadJoypad(0);
			if (result > 0) {

				// Restart to roll dice.
				if (cubeJoypadMotion()) {
					if (rolling > 10) {
						result = 0;
						angle = 0;
						rolling = 0;
					}
				}
			} else {

				// Hold to rolling dice.
				if (cubeJoypadMotion()) {
					rolling = 1;

				// Timeout and show result.
				} else if (rolling > 60) {
					for (var y = 0; y < lines; y++) {
						for (var x = 0; x < rows[y]; x++) {
							result += randoms[lineMax*y+x];
						}
					}
					angle = 0;
					rolling = 1;
				}
			}

			// Roll sprites.
			if (result <= 0) {
				angle = (angle + 20) % 360;
				for (var y = 0; y < lines; y++) {
					for (var x = 0; x < rows[y]; x++) {
						randoms[lineMax*y+x] = cubeRandom(maximum) + 1;
					}
				}
			}

			// Update sprites.
			for (var y = 0; y < lines; y++) {
				for (var x = 0; x < rows[y]; x++) {
					cubeAnimate(randoms[lineMax*y+x] - 1, sprites[lineMax*y+x]);
					if (rolling < 5) {
						cubeExpand(scale * (0.8 + 0.04 * rolling), sprites[lineMax*y+x]);
					} else {
						cubeExpand(scale, sprites[lineMax*y+x]);
					}
					cubeRotate(angle, sprites[lineMax*y+x]);
					var sx = size.x / (rows[y] + 1) * (x + 1);
					var sy = size.y / (lines + 1) * (y + 1);
					cubeMove(sx, sy + 20, sprites[lineMax*y+x]);
				}
			}
			cubeAnimate(maximum - 1, sprite);
			cubeExpand(0.5, sprite);
			cubeDilute(0.1, sprite);
			cubeMove(size.x / 2, 30, sprite);

			// Clear screen.
			cubeClear();

			// Draw sprites.
			for (var y = 0; y < lines; y++) {
				for (var x = 0; x < rows[y]; x++) {
					cubeDraw(sprites[lineMax*y+x]);
				}
			}
			cubeDraw(sprite);

			await cubeWait(10);
		}
	}
})();</script><!--/Main-->
</body>
</html>
